<!doctype html>
<html>
<head>
<script src="./babel-browser.min.js"></script>
<script src="../node_modules/es6-module-loader/dist/es6-module-loader-dev.js"></script>
<script src="../bower_components/jxon/index.js"></script>
<script>
System.transpiler = 'babel';
</script>
<style>
div{
  display: inline-block ;
  position: relative ;
}
div::after{
  position: absolute;
  content: attr(title);
  text-shadow: 0 0 .125em #fff;
  left: 0;
  color: #000;
  padding: 1em;
}
</style>
</head>
<body>
<script>
'use strict';
System.import(
  '../FRONTIERS.js'
).then(function(Frontiers){
  Frontiers = Frontiers.default;
  window.Frontiers = Frontiers;
  console.log('FRONTIERS.JS is loaded!');
  function setDisabled(isDisabled){
    var
      disabledStuffs = this.querySelectorAll('*[disabled]'),
      i = 0|0
    ;
    for(i=0;i<disabledStuffs.length;++i){
      disabledStuffs[i].disabled = isDisabled;
    }
  }
  var
    form = document.querySelector('form'),
    directory = form.querySelector('[type="url"]'),
    resolution = form.querySelector('#resolution'),
    resolutionOut = form.querySelector('[for="resolution"]'),
    texturesGoHere = document.querySelector('#textures-go-here'),
    path = location.pathname.split('/'),
    failureLogger = function(failure){
      alert('Error!');
      console.error(failure);
    }
  ;
  path.pop();
  path.pop();
  path.push('Data');
  path.unshift(location.hostname);
  directory.value = location.protocol + '//' + path.join('/');
  setDisabled.call(form, false);
  function doStuff(){
    if(
      (resolution.value & (resolution.value - 1)) !== 0
    ){
      alert('resolution must be power of two!');
      return;
    }
    setDisabled.call(form, true);
    while(texturesGoHere.hasChildNodes()){
      texturesGoHere.removeChild(texturesGoHere.firstChild);
    }
    Frontiers.Data.GameData.IO.InitializeSystemPaths(
      directory.value
    ).catch(function(e){
      alert('Error!');
      console.error(e);
    }).then(function(e){
      Frontiers.Data.GameData.IO.LoadWorld('FRONTIERS').then(function(world){
        Promise.all(world.DefaultRevealedLocations.map(
          function(revealedLocation){
            return Frontiers.Mods.Get.Runtime.LoadMod(
              'Chunk',
              revealedLocation.ChunkName
            ).then(function(ChunkState){
              return Frontiers.Data.GameData.IO.LoadTerrainMap(
                parseInt(resolution.value, 10|0),
                false,
                true,
                ChunkState.Name,
                'ColorOverlay',
                Frontiers.DataType.World
              ).then(function(e){
                var
                  div = document.createElement('div')
                ;
                div.setAttribute('title', revealedLocation.FullPath);
                div.appendChild(e.canvas);
                return div;
              }, failureLogger);
            });
          }
        )).then(function(divs){
          for(var div of divs){
            texturesGoHere.appendChild(div);
          }
          setDisabled.call(form, false);
        }, failureLogger);
      });
    });
  }
  form.addEventListener('submit', function(e){
    e.preventDefault();
    setDisabled.call(this, true);
    doStuff();
  });
  resolution.addEventListener('change', function(){
    resolutionOut.textContent = this.value;
  });
  doStuff();
}, function(failure){
  console.error(failure);
});
</script>
<form>
<input
  type="url"
  placeholder="path to folder for a Chunk"
  disabled
>
<datalist id="powers-of-two">
  <option>2048</option>
  <option>1024</option>
  <option>512</option>
  <option>256</option>
  <option>128</option>
  <option>64</option>
  <option>32</option>
  <option>16</option>
  <option>8</option>
  <option>4</option>
  <option>2</option>
  <option>1</option>
</datalist>
<label>
  <input
    id="resolution"
    type="range"
    min="1"
    max="2048"
    value="512"
    list="powers-of-two"
    disabled
  >
  <output for="resolution">512</output>
  <span>Resolution</span>
</label>
<button type="submit" disabled>Get</button>
</form>
<div id="textures-go-here"></div>
</body>
</html>
