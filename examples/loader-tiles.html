<!doctype html>
<html>
<head>
<script src="./babel-browser.min.js"></script>
<script src="../node_modules/es6-module-loader/dist/es6-module-loader-dev.js"></script>
<script src="../bower_components/jxon/index.js"></script>
<script>
System.transpiler = 'babel';
</script>
<style>
table{
  border-collapse: collapse ;
}
td{
  padding: 0 ;
}
canvas{
  display: block ;
}
td:hover{
  border: 4px solid #f00 ;
}
</style>
</head>
<body>
<script>
'use strict';
System.import(
  '../Frontiers.js'
).then(function(Frontiers){
  Frontiers = Frontiers.default;
  window.Frontiers = Frontiers;
  console.log('FRONTIERS.JS is loaded!');
  function setDisabled(isDisabled){
    var
      disabledStuffs = this.querySelectorAll('*[disabled]'),
      i = 0|0
    ;
    for(i=0;i<disabledStuffs.length;++i){
      disabledStuffs[i].disabled = isDisabled;
    }
  }
  var
    form = document.querySelector('form'),
    directory = form.querySelector('[type="url"]'),
    xTiles = form.querySelector('#x-tiles'),
    xTilesOut = form.querySelector('output[for="x-tiles"]'),
    zTiles = form.querySelector('#z-tiles'),
    zTilesOut = form.querySelector('output[for="z-tiles"]'),
    path = location.pathname.split('/')
  ;
  path.pop();
  path.pop();
  path.push('Data');
  path.unshift(location.hostname);
  directory.value = location.protocol + '//' + path.join('/');
  setDisabled.call(form, false);
  xTiles.addEventListener('change', function(){
    xTilesOut.textContent = this.value;
  });
  zTiles.addEventListener('change', function(){
    zTilesOut.textContent = this.value;
  });
  form.addEventListener('submit', function(e){
    e.preventDefault();
    var
      resolution = 513,
      chunkName = 'C-0-0-100',
      filename = 'Raw16Mac',
      datatype = Frontiers.DataType.World,
      table = document.createElement('table'),
      makeGetTileCanvas = function(goHere){
        return function(tile){
          tile.Canvas().then(function(canvas){
            goHere.appendChild(canvas);
          });
        };
      },
      x = 0|0,
      z = 0|0,
      xTilesVal = xTiles.value,
      zTilesVal = zTiles.value,
      sw = ((resolution - 1) / xTilesVal) + 1,
      sh = ((resolution - 1) / zTilesVal) + 1
    ;
    if(
      (xTilesVal & (xTilesVal - 1)) !== 0 ||
      (zTilesVal & (zTilesVal - 1)) !== 0
    ){
      alert('tiles must be power of two!');
      return;
    }
    setDisabled.call(this, true);
    Frontiers.Data.GameData.IO.InitializeSystemPaths(
      directory.value
    ).catch(function(e){
      alert('Error!');
      console.error(e);
    }).then(function(e){
      var
        tables = document.querySelectorAll('body > table'),
        i=0|0
      ;
      for(i=0;i<tables.length;++i){
        document.body.removeChild(tables[i]);
      }
      document.body.appendChild(table);
      for(z=0;z<zTilesVal;++z){
        var
          tr = document.createElement('tr')
        ;
        table.appendChild(tr);
        for(x=0;x<xTilesVal;++x){
          var
            td = document.createElement('td')
          ;
          tr.appendChild(td);
          Frontiers.Data.GameData.IO.LoadTerrainTile(
            (x * (resolution - 1) / xTilesVal),
            (z * (resolution - 1) / zTilesVal),
            sw,
            sh,
            resolution,
            chunkName,
            filename,
            datatype
          ).then(makeGetTileCanvas(td));
        }
      }
    });
  });
}, function(failure){
  console.error(failure);
});
</script>
<form>
<input
  type="url"
  placeholder="path to folder for a Chunk"
  disabled
>
<datalist id="powers-of-two">
  <option>1</option>
  <option>2</option>
  <option>4</option>
  <option>8</option>
  <option>16</option>
  <option>32</option>
  <option>64</option>
</datalist>
<label>
  <input
    id="x-tiles"
    type="range"
    min="1"
    max="64"
    value="2"
    list="powers-of-two"
    disabled
  >
  <output for="x-tiles">2</output>
  <span>x-tiles</span>
</label>
<label>
  <input
    id="z-tiles"
    type="range"
    min="1"
    max="64"
    value="2"
    list="powers-of-two"
    disabled
  >
  <output for="z-tiles">2</output>
  <span>z-tiles</span>
</label>
<button type="submit" disabled>Get</button>
</form>
</body>
</html>
